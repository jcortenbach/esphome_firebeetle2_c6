kind: pipeline
type: docker
name: default

steps:
  - name: build
    image: debian:stable
    environment:
      WIFI_SSID:
        from_secret: wifi_ssid
      WIFI_PASSWORD:
        from_secret: wifi_password
      API_KEY:
        from_secret: api_key
    commands:
      - echo wifi_ssid:\ \"$WIFI_SSID\" > secrets.yaml
      - echo wifi_password:\ \"$WIFI_PASSWORD\" >> secrets.yaml
      - echo api_key:\ \"$API_KEY\" >> secrets.yaml
      - apt update -qq > /dev/null
      - |
        apt install -qq -y \
          git python3-virtualenv python3-venv python3-pip python3-dev \
          python3-wheel \
          > /dev/null
      - virtualenv venv-drone
      - venv-drone/bin/pip install -q esphome
      - venv-drone/bin/esphome compile lifire.yaml
